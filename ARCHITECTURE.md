# Music-IO Architecture Documentation

## Project Overview

Music-IO is an interactive robotic game installation that combines physical hardware (Arduino controllers, servos, sensors, pumps) with a web-based game interface. The system uses **Hexagonal Architecture (Ports & Adapters)** to maintain clean separation between business logic and external hardware/software interfaces.

---

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    MUSIC-IO SYSTEM                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           HARDWARE LAYER (Arduino)                            â”‚   â”‚
â”‚  â”‚                                                                               â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚   â”‚     STAGE 1 (COM7)          â”‚    â”‚     STAGE 2 (COM4)          â”‚         â”‚   â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚         â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ HC-SR04 Proximity   â”‚    â”‚    â”‚  â”‚ Suction Pump        â”‚    â”‚         â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Button (Pin 9)      â”‚    â”‚    â”‚  â”‚ Solenoid Valve      â”‚    â”‚         â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ Relay (Pin 8)       â”‚    â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ SG90 Servos (x2)    â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ DS04 360Â° Servo     â”‚    â”‚                                             â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ KS3518 Arm (x4)     â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚   â”‚  â”‚ PCA9685 PWM Driver  â”‚    â”‚    â”‚     THERMAL PRINTER         â”‚         â”‚   â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚  (Windows Printer API)      â”‚         â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                    Serial/USB                                        â”‚
â”‚                                         â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           ADAPTER LAYER (Python)                              â”‚   â”‚
â”‚  â”‚                                                                               â”‚   â”‚
â”‚  â”‚   INPUT ADAPTERS                         OUTPUT ADAPTERS                      â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚   â”‚ ServoAdapter        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ PumpAdapter         â”‚              â”‚   â”‚
â”‚  â”‚   â”‚ (reads button,      â”‚   bridges     â”‚ (controls pump)     â”‚              â”‚   â”‚
â”‚  â”‚   â”‚  proximity, relay)  â”‚   commands    â”‚                     â”‚              â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚   â”‚ WebcamAdapter       â”‚               â”‚ ThermalPrinterAdapterâ”‚             â”‚   â”‚
â”‚  â”‚   â”‚ (hand detection)    â”‚               â”‚ (prints thank you)  â”‚              â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚                                         â”‚ WebVisualizerAdapterâ”‚              â”‚   â”‚
â”‚  â”‚                                         â”‚ (Socket.IO server)  â”‚              â”‚   â”‚
â”‚  â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚                                         â”‚ LocalAudioAdapter   â”‚              â”‚   â”‚
â”‚  â”‚                                         â”‚ (sound generation)  â”‚              â”‚   â”‚
â”‚  â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                    Callbacks                                         â”‚
â”‚                                         â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         APPLICATION LAYER (Python)                            â”‚   â”‚
â”‚  â”‚                                                                               â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚   â”‚                    MusicMachineApplication                           â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - Dependency Injection                                              â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - Event Routing (callbacks)                                         â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - Game State Management                                             â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - Adapter Lifecycle                                                 â”‚    â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                    Domain Events                                     â”‚
â”‚                                         â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           CORE DOMAIN (Python)                                â”‚   â”‚
â”‚  â”‚                                                                               â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚   â”‚ SoundOrchestrator   â”‚    â”‚ MusicStateMachine   â”‚                         â”‚   â”‚
â”‚  â”‚   â”‚ (multi-track mixing)â”‚    â”‚ (state transitions) â”‚                         â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚   â”‚ Domain Events: ProximityEvent, SoundEvent,      â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚                ButtonEvent, StateChangeEvent    â”‚                        â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                    Socket.IO                                         â”‚
â”‚                                         â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           WEB LAYER (Browser)                                 â”‚   â”‚
â”‚  â”‚                                                                               â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚   â”‚                    game_visualizer.html                              â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - Canvas Game (Pulse Jump)                                          â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - Webcam Hand Detection                                             â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - Joystick/Keyboard Input                                           â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - "Ven a Jugar" Proximity Invite                                    â”‚    â”‚   â”‚
â”‚  â”‚   â”‚  - Score Tracking & Win/Lose Detection                               â”‚    â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Hexagonal Architecture Explained

### What is Hexagonal Architecture?

Hexagonal Architecture (also called Ports & Adapters) is a software design pattern that isolates the **core business logic** from external concerns like databases, UI, hardware, and APIs.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚                    EXTERNAL WORLD                               â”‚
â”‚    (Arduino, Web Browser, Printer, Webcam, etc.)                â”‚
â”‚                                                                 â”‚
â”‚         â”‚                                      â”‚                â”‚
â”‚         â–¼                                      â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  INPUT    â”‚                          â”‚  OUTPUT   â”‚          â”‚
â”‚   â”‚ ADAPTERS  â”‚                          â”‚ ADAPTERS  â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                      â”‚                â”‚
â”‚         â–¼                                      â”‚                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  INPUT    â”‚                          â”‚  OUTPUT   â”‚          â”‚
â”‚   â”‚  PORTS    â”‚                          â”‚  PORTS    â”‚          â”‚
â”‚   â”‚(interfaces)                          â”‚(interfaces)          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                                      â”‚                â”‚
â”‚         â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â–ºâ”‚    CORE DOMAIN      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                â”‚  (Business Logic)   â”‚                          â”‚
â”‚                â”‚  - State Machine    â”‚                          â”‚
â”‚                â”‚  - Orchestrator     â”‚                          â”‚
â”‚                â”‚  - Domain Events    â”‚                          â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### How Music-IO Applies Hexagonal Architecture

| Layer | Location | Responsibility |
|-------|----------|----------------|
| **Core Domain** | `src/core/domain/` | Business logic, state machine, event definitions |
| **Ports** | `src/core/ports/` | Abstract interfaces (contracts) |
| **Input Adapters** | `src/adapters/input/` | Arduino serial, webcam, button readers |
| **Output Adapters** | `src/adapters/output/` | Servo control, pump, printer, web visualizer |
| **Application** | `src/app/` | Wires everything together, dependency injection |

---

## Directory Structure

```
Music-IO/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ application.py      # Main orchestrator (DI container)
â”‚   â”‚   â””â”€â”€ main.py             # Entry point
â”‚   â”‚
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ events.py       # ProximityEvent, SoundEvent, etc.
â”‚   â”‚   â”‚   â”œâ”€â”€ orchestrator.py # SoundOrchestrator (multi-track)
â”‚   â”‚   â”‚   â””â”€â”€ state_machine.py# MusicStateMachine
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ ports/
â”‚   â”‚       â”œâ”€â”€ input_port.py   # InputPort interface
â”‚   â”‚       â””â”€â”€ output_port.py  # OutputPort, VisualizationOutputPort
â”‚   â”‚
â”‚   â””â”€â”€ adapters/
â”‚       â”œâ”€â”€ input/
â”‚       â”‚   â”œâ”€â”€ arduino_adapter.py  # Proximity sensor reader
â”‚       â”‚   â”œâ”€â”€ button_adapter.py   # Button event reader
â”‚       â”‚   â””â”€â”€ webcam_adapter.py   # Hand detection via webcam
â”‚       â”‚
â”‚       â””â”€â”€ output/
â”‚           â”œâ”€â”€ servo_adapter.py           # Stage 1 Arduino (COM7)
â”‚           â”œâ”€â”€ pump_adapter.py            # Stage 2 Arduino (COM4)
â”‚           â”œâ”€â”€ thermal_printer_adapter_win.py # Windows printer
â”‚           â”œâ”€â”€ web_visualizer_adapter.py  # Flask + Socket.IO
â”‚           â””â”€â”€ local_audio_adapter.py     # PyAudio sound
â”‚
â”œâ”€â”€ arduino/
â”‚   â””â”€â”€ servo_controller/
â”‚       â””â”€â”€ stage_1.ino         # Main Arduino code (Stage 1)
â”‚
â””â”€â”€ web/
    â””â”€â”€ templates/
        â””â”€â”€ game_visualizer.html # Browser game UI
```

---

## Complete Game Flow

### Phase 1: Idle State (Waiting for Player)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         IDLE STATE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   [Arduino Stage 1]                                              â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ HC-SR04 checks distance every 200ms                     â”‚
â”‚        â”‚                                                         â”‚
â”‚        â–¼                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚ distance <= 50cm?                       â”‚                    â”‚
â”‚   â”‚   YES â†’ Send {"invite":"Ven a Jugar"}   â”‚                    â”‚
â”‚   â”‚   NO  â†’ Send {"invite":""}              â”‚                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ Serial (JSON)                                           â”‚
â”‚        â–¼                                                         â”‚
â”‚   [Python: ServoAdapter._process_serial_message()]               â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ Calls _invite_callback                                  â”‚
â”‚        â–¼                                                         â”‚
â”‚   [Python: Application._handle_proximity_invite()]               â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ socketio.emit('proximity_invite', {invite: text})       â”‚
â”‚        â–¼                                                         â”‚
â”‚   [Browser: game_visualizer.html]                                â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ Shows/hides "Ven a Jugar" text at bottom                â”‚
â”‚        â–¼                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚   â”‚  ğŸ® Â¡Ven a Jugar! ğŸ®                    â”‚  â† Pulsing text    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: Game Start (Button Press)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       GAME START                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   [Physical Button on Arduino Pin 9]                             â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ Button pressed (LOW)                                    â”‚
â”‚        â–¼                                                         â”‚
â”‚   [Arduino Stage 1]                                              â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”œâ”€â–º Send {"button":"pressed"}                             â”‚
â”‚        â”œâ”€â–º setRelay(true)  â†’ Opens relay (Pin 8 HIGH)            â”‚
â”‚        â”œâ”€â–º performSG90Dance() â†’ 5 seconds random servo movement  â”‚
â”‚        â””â”€â–º Send {"status":"game_initiated"}                      â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ Serial (JSON)                                           â”‚
â”‚        â–¼                                                         â”‚
â”‚   [Python: ServoAdapter._process_serial_message()]               â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”œâ”€â–º Calls _button_callback                                â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Application._handle_stage1_button()]                 â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â”‚ socketio.emit('game_start_trigger')            â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Browser: socket.on('game_start_trigger')]            â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â”œâ”€â–º Hide invite text                             â”‚
â”‚        â”‚        â”œâ”€â–º game.gameStarted = true                      â”‚
â”‚        â”‚        â””â”€â–º Start 60-second survival timer               â”‚
â”‚        â”‚                                                         â”‚
â”‚        â””â”€â–º Logs "GAME INITIATED"                                 â”‚
â”‚                                                                  â”‚
â”‚   [Arduino State: WAITING_FOR_RESULT]                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 3: Gameplay (Browser)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GAMEPLAY                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   [Browser: game_visualizer.html - Canvas Game]                  â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚ Player controls: Arrow keys / Joystick                  â”‚
â”‚        â”‚ Objective: Survive 60 seconds, collect sushi            â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”œâ”€â–º [Webcam Adapter] Hand detection spawns enemies        â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â”‚ MediaPipe hand tracking                        â”‚
â”‚        â”‚        â”‚ Left hand â†’ spawn enemy                        â”‚
â”‚        â”‚        â”‚ Right hand â†’ spawn collectible                 â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   socketio.emit('hand_raised_left/right')               â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Python: WebVisualizerAdapter]                        â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â”‚ socketio.emit('spawn_enemy/collectible')       â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Browser: Creates game entity]                        â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                    GAME OUTCOMES                         â”‚    â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚   â”‚                                                          â”‚    â”‚
â”‚   â”‚   [LOSE: Player dies OR score < 10]                      â”‚    â”‚
â”‚   â”‚        â”‚                                                 â”‚    â”‚
â”‚   â”‚        â”‚ socket.emit('game_over', {score, reason:'death'})   â”‚
â”‚   â”‚        â–¼                                                 â”‚    â”‚
â”‚   â”‚   [Python: Application._handle_game_over()]              â”‚    â”‚
â”‚   â”‚        â”‚                                                 â”‚    â”‚
â”‚   â”‚        â”‚ servo_adapter.activate_motor_by_score(score)    â”‚    â”‚
â”‚   â”‚        â”‚ score < 10 â†’ sends "LOSE" to Arduino            â”‚    â”‚
â”‚   â”‚        â–¼                                                 â”‚    â”‚
â”‚   â”‚   [Arduino: Receives "LOSE"]                             â”‚    â”‚
â”‚   â”‚        â”‚                                                 â”‚    â”‚
â”‚   â”‚        â”œâ”€â–º setRelay(false) â†’ Closes relay                â”‚    â”‚
â”‚   â”‚        â””â”€â–º resetToIdle()                                 â”‚    â”‚
â”‚   â”‚                                                          â”‚    â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚
â”‚   â”‚                                                          â”‚    â”‚
â”‚   â”‚   [WIN: Survives 60 seconds AND score >= 10]             â”‚    â”‚
â”‚   â”‚        â”‚                                                 â”‚    â”‚
â”‚   â”‚        â”‚ socket.emit('game_over', {score, reason:'victory'}) â”‚
â”‚   â”‚        â–¼                                                 â”‚    â”‚
â”‚   â”‚   [Python: Application._handle_game_over()]              â”‚    â”‚
â”‚   â”‚        â”‚                                                 â”‚    â”‚
â”‚   â”‚        â”‚ servo_adapter.activate_motor_by_score(score)    â”‚    â”‚
â”‚   â”‚        â”‚ score >= 10 â†’ sends "WIN" to Arduino            â”‚    â”‚
â”‚   â”‚        â–¼                                                 â”‚    â”‚
â”‚   â”‚   [Arduino: Receives "WIN" â†’ WIN SEQUENCE]               â”‚    â”‚
â”‚   â”‚                                                          â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 4: Win Sequence (Robotic Prize Delivery)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WIN SEQUENCE                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   [Arduino Stage 1: performWinSequence()]                        â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 1: DS04 360Â° Servo Dance                                  â”‚
â”‚        â”‚   - Rotate right slow (5 sec)                           â”‚
â”‚        â”‚   - Stop (2 sec)                                        â”‚
â”‚        â”‚   - Rotate left slow (5 sec)                            â”‚
â”‚        â”‚   - Stop (2 sec)                                        â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 2: Lower Arms Forward (90Â°)                               â”‚
â”‚        â”‚   - moveKS(LOWER_LEFT, 0 â†’ 90)                          â”‚
â”‚        â”‚   - moveKS(LOWER_RIGHT, 0 â†’ 90)                         â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 3: Align Upper Arm (90Â°)                                  â”‚
â”‚        â”‚   - moveKS(UPPER_ARM, 10 â†’ 90)                          â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 4: Lower Forearm for Reach (-22Â°)                         â”‚
â”‚        â”‚   - moveKS(LOWER_LEFT, 90 â†’ 68)                         â”‚
â”‚        â”‚   - moveKS(LOWER_RIGHT, 90 â†’ 68)                        â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 5: Activate Suction Pump                                  â”‚
â”‚        â”‚   - Send {"action":"activate_pump"}                     â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â”‚ Serial to Python                               â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Python: ServoAdapter._process_serial_message()]      â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â”‚ pump_adapter.activate_pump()                   â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Python: PumpAdapter]                                 â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â”‚ Serial "PUMP_ON" to COM4                       â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Arduino Stage 2: Pump activates]                     â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚   - Wait 5 seconds (grip object)                        â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 6: Return Forearm to 90Â°                                  â”‚
â”‚        â”‚   - moveKS(LOWER_LEFT, 68 â†’ 90)                         â”‚
â”‚        â”‚   - moveKS(LOWER_RIGHT, 68 â†’ 90)                        â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 7: Rotate Base Left (75Â°)                                 â”‚
â”‚        â”‚   - moveKS(BASE_SERVO, 90 â†’ 15)                         â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 8: Release Object                                         â”‚
â”‚        â”‚   - Send {"action":"deactivate_pump"}                   â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Python â†’ Stage 2: "PUMP_OFF"]                        â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”‚   - Send {"status":"sequence_complete"}                 â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Python: ServoAdapter._process_serial_message()]      â”‚
â”‚        â”‚        â”‚                                                â”‚
â”‚        â”‚        â”‚ printer_adapter.print_thank_you()              â”‚
â”‚        â”‚        â–¼                                                â”‚
â”‚        â”‚   [Thermal Printer: Prints thank you message]           â”‚
â”‚        â”‚                                                         â”‚
â”‚   STEP 9: Close Relay & Reset                                    â”‚
â”‚        â”‚   - setRelay(false)                                     â”‚
â”‚        â”‚   - resetToIdle()                                       â”‚
â”‚        â”‚                                                         â”‚
â”‚        â–¼                                                         â”‚
â”‚   [System returns to IDLE state]                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Hardware Components

### Stage 1 Arduino (COM7)

| Component | Pin | Purpose |
|-----------|-----|---------|
| **HC-SR04 Proximity** | Trigger: 7, Echo: 6 | Detect user presence (50cm threshold) |
| **Button** | Pin 9 (INPUT_PULLUP) | Start game |
| **Relay (SRD-05VDC)** | Pin 8 | Control external device during game |
| **PCA9685 PWM Driver** | I2C | Control all servos |
| **SG90 Servos (x2)** | PCA Ch 0, 1 | Dance animation at game start |
| **DS04-NFC 360Â° Servo** | PCA Ch 3 | Rotating platform |
| **KS3518 Arm Servos (x4)** | PCA Ch 8-11 | Robotic arm (base, lower x2, upper) |

### Stage 2 Arduino (COM4)

| Component | Purpose |
|-----------|---------|
| **Suction Pump** | Pick up prize |
| **Solenoid Valve** | Release prize |

### Thermal Printer

| Type | Connection |
|------|------------|
| USB Thermal Printer | Windows Printer API |

---

## Serial Communication Protocol

### Stage 1 â†’ Python (JSON)

```json
// Button pressed
{"button":"pressed"}

// Proximity invite
{"invite":"Ven a Jugar"}
{"invite":""}

// Relay status
{"relay":"open"}
{"relay":"closed"}

// Status updates
{"status":"ready"}
{"status":"idle"}
{"status":"game_initiated"}
{"status":"win_sequence_start"}
{"status":"sequence_complete"}

// Pump commands (bridged to Stage 2)
{"action":"activate_pump"}
{"action":"deactivate_pump"}
```

### Python â†’ Stage 1 (Plain text)

```
WIN
LOSE
START_GAME
RESET
```

### Python â†’ Stage 2 (Plain text)

```
PUMP_ON
PUMP_OFF
```

---

## Callback Chain

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CALLBACK REGISTRATION                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   [Application.start()]                                          â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”œâ”€â–º servo_adapter.register_button_callback(               â”‚
â”‚        â”‚       _handle_stage1_button)                            â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”œâ”€â–º servo_adapter.register_invite_callback(               â”‚
â”‚        â”‚       _handle_proximity_invite)                         â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”œâ”€â–º servo_adapter.set_pump_adapter(pump_adapter)          â”‚
â”‚        â”‚       â””â”€â–º pump_adapter.register_deactivation_callback(  â”‚
â”‚        â”‚               _on_pump_deactivation_complete)           â”‚
â”‚        â”‚                                                         â”‚
â”‚        â”œâ”€â–º servo_adapter.set_printer_adapter(printer_adapter)    â”‚
â”‚        â”‚                                                         â”‚
â”‚        â””â”€â–º visualizer.register_game_callbacks(                   â”‚
â”‚                game_start_callback=_handle_game_start,           â”‚
â”‚                game_over_callback=_handle_game_over)             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ports (Interfaces)

### InputPort (`src/core/ports/input_port.py`)

```python
class InputPort(ABC):
    @abstractmethod
    def start(self): pass
    
    @abstractmethod
    def stop(self): pass
    
    @abstractmethod
    def is_running(self) -> bool: pass
    
    @abstractmethod
    def register_callback(self, callback: Callable[[ProximityEvent], None]): pass
```

### OutputPort (`src/core/ports/output_port.py`)

```python
class OutputPort(ABC):
    @abstractmethod
    def initialize(self) -> bool: pass
    
    @abstractmethod
    def play_sound(self, sound_event: SoundEvent) -> bool: pass
    
    @abstractmethod
    def stop(self): pass
    
    @abstractmethod
    def is_available(self) -> bool: pass
    
    @abstractmethod
    def get_output_info(self) -> dict: pass
```

### VisualizationOutputPort

```python
class VisualizationOutputPort(ABC):
    @abstractmethod
    def initialize(self) -> bool: pass
    
    @abstractmethod
    def visualize_proximity(self, proximity_event): pass
    
    @abstractmethod
    def visualize_sound(self, sound_event: SoundEvent): pass
    
    @abstractmethod
    def stop(self): pass
```

---

## Domain Events

| Event | Fields | Purpose |
|-------|--------|---------|
| `ProximityEvent` | distance, sensor_id, timestamp | User proximity detection |
| `SoundEvent` | frequency, duration, amplitude | Audio generation |
| `ButtonEvent` | button_state, timestamp | Physical button press |
| `StateChangeEvent` | old_state, new_state, reason | State machine transitions |

---

## State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GAME STATE MACHINE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚   â”‚  IDLE  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                           â”‚         â”‚
â”‚       â”‚                                                â”‚         â”‚
â”‚       â”‚ Button pressed OR "START_GAME" command         â”‚         â”‚
â”‚       â–¼                                                â”‚         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚         â”‚
â”‚   â”‚ GAME_STARTED â”‚                                     â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                     â”‚         â”‚
â”‚           â”‚                                            â”‚         â”‚
â”‚           â”‚ SG90 dance complete                        â”‚         â”‚
â”‚           â–¼                                            â”‚         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚         â”‚
â”‚   â”‚ WAITING_FOR_RESULT â”‚                               â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚         â”‚
â”‚             â”‚                                          â”‚         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚         â”‚
â”‚     â”‚               â”‚                                  â”‚         â”‚
â”‚     â–¼               â–¼                                  â”‚         â”‚
â”‚  "WIN"           "LOSE"                                â”‚         â”‚
â”‚     â”‚               â”‚                                  â”‚         â”‚
â”‚     â–¼               â”‚                                  â”‚         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                  â”‚         â”‚
â”‚   â”‚ WIN_SEQUENCE â”‚  â”‚                                  â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚                                  â”‚         â”‚
â”‚           â”‚         â”‚                                  â”‚         â”‚
â”‚           â”‚ sequence_complete                          â”‚         â”‚
â”‚           â”‚         â”‚                                  â”‚         â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Running the System

### Prerequisites

```bash
pip install pyserial flask flask-socketio pyaudio
```

### Start Command

```bash
cd src
python -m app.main
```

### Configuration Options

```python
app = MusicMachineApplication(
    enable_servo=True,      # Stage 1 - COM7
    enable_pump=True,       # Stage 2 - COM4
    enable_printer=True,    # Thermal printer
    enable_visualizer=True, # Web game interface
)
```

### Access Web Game

Open browser: `http://127.0.0.1:5000/game`

---

## Benefits of This Architecture

1. **Testability**: Core domain can be unit tested without hardware
2. **Flexibility**: Easy to swap Arduino for different hardware
3. **Maintainability**: Clear separation of concerns
4. **Extensibility**: Add new adapters without changing core logic
5. **Debugging**: Each layer can be tested independently

---

## References

- [Hexagonal Architecture by Alistair Cockburn](https://alistair.cockburn.us/hexagonal-architecture/)
- [Clean Architecture by Robert C. Martin](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Domain-Driven Design by Eric Evans](https://www.domainlanguage.com/ddd/)
